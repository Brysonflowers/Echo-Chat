{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="flex flex-col h-screen bg-gray-900 text-white">
    <div class="flex justify-between items-center p-4 bg-gray-800 border-b border-gray-700">
        <h1 class="text-2xl font-bold text-emerald-400">EchoChat</h1>
        <div>
            <span id="online-count" class="pr-2"></span>
            <span class="text-sm">online</span>
        </div>
    </div>

    <div id="chat_container" class="flex-grow overflow-y-auto p-4">
        <ul id="chat_messages" class="space-y-4">
            {% for message in messages %}
                {% if message.user == request.user %}
                    <li class="flex justify-end">
                        <div class="bg-emerald-500 text-white rounded-l-lg rounded-tr-lg p-3 max-w-xs">
                            <p>{{ message.message }}</p>
                        </div>
                    </li>
                {% else %}
                    <li>
                        <div class="flex justify-start">
                            <div class="bg-gray-700 rounded-r-lg rounded-tl-lg p-3 max-w-xs">
                                <p class="font-semibold text-emerald-300">{{ message.user.username }}</p>
                                <p>{{ message.message }}</p>
                            </div>
                        </div>
                    </li>
                {% endif %}
            {% endfor %}
        </ul>
    </div>

    <div class="p-4 bg-gray-800 border-t border-gray-700">
        <form id="chat_message_form" method="POST" class="flex items-center">
            <input id="chat_message_input" type="text" name="message" placeholder="Type a message..." maxlength="255"
                   class="flex-grow bg-gray-700 text-white rounded-full py-2 px-4 focus:outline-none focus:ring-2 focus:ring-emerald-500">
            <button type="submit" class="ml-4 bg-emerald-500 text-white rounded-full p-2 hover:bg-emerald-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                     stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M5 12h14M12 5l7 7-7 7"/>
                </svg>
            </button>
        </form>
    </div>
</div>

<script>
    const chatContainer = document.getElementById('chat_container');
    chatContainer.scrollTop = chatContainer.scrollHeight;

    const chatSocket = new WebSocket(
        'ws://'
        + window.location.host
        + '/ws/chat/'
    );

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const chatMessages = document.getElementById('chat_messages');
        const messageElement = document.createElement('li');
        const username = data.username;
        const message = data.message;

        if (username === "{{ request.user.username }}") {
            messageElement.classList.add('flex', 'justify-end');
            messageElement.innerHTML = `
                <div class="bg-emerald-500 text-white rounded-l-lg rounded-tr-lg p-3 max-w-xs">
                    <p>${message}</p>
                </div>
            `;
        } else {
            messageElement.classList.add('flex', 'justify-start');
            messageElement.innerHTML = `
                <div class="bg-gray-700 rounded-r-lg rounded-tl-lg p-3 max-w-xs">
                    <p class="font-semibold text-emerald-300">${username}</p>
                    <p>${message}</p>
                </div>
            `;
        }
        chatMessages.appendChild(messageElement);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.getElementById('chat_message_form').onsubmit = function(e) {
        e.preventDefault();
        const messageInputDom = document.getElementById('chat_message_input');
        const message = messageInputDom.value;
        if (message.trim() !== '') {
            chatSocket.send(JSON.stringify({
                'message': message
            }));
            messageInputDom.value = '';
        }
    };
</script>
{% endblock %}
